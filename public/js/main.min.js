var initPhotoSwipeFromDOM=function(e){for(var t=function(e){for(var t,s,a,n,i=e.childNodes,l=i.length,r=[],o=0;o<l;o++)t=i[o],1===t.nodeType&&(s=t.children[0],a=s.getAttribute("data-size").split("x"),n={src:s.getAttribute("href"),w:parseInt(a[0],10),h:parseInt(a[1],10)},t.children.length>1&&(n.title=t.children[1].innerHTML),s.children.length>0&&(n.msrc=s.children[0].getAttribute("src")),n.el=t,r.push(n));return r},s=function e(t,s){return t&&(s(t)?t:e(t.parentNode,s))},a=function(e){e=e||window.event,e.preventDefault?e.preventDefault():e.returnValue=!1;var t=e.target||e.srcElement,a=s(t,function(e){return e.tagName&&"FIGURE"===e.tagName.toUpperCase()});if(a){for(var n,l=a.parentNode,r=a.parentNode.childNodes,o=r.length,c=0,g=0;g<o;g++)if(1===r[g].nodeType){if(r[g]===a){n=c;break}c++}return n>=0&&i(n,l),!1}},n=function(){var e=window.location.hash.substring(1),t={};if(e.length<5)return t;for(var s=e.split("&"),a=0;a<s.length;a++)if(s[a]){var n=s[a].split("=");n.length<2||(t[n[0]]=n[1])}return t.gid&&(t.gid=parseInt(t.gid,10)),t},i=function(e,s,a,n){var i,l,r,o=document.querySelectorAll(".pswp")[0];if(r=t(s),l={galleryUID:s.getAttribute("data-pswp-uid"),getThumbBoundsFn:function(e){var t=r[e].el.getElementsByTagName("img")[0],s=window.pageYOffset||document.documentElement.scrollTop,a=t.getBoundingClientRect();return{x:a.left,y:a.top+s,w:a.width}}},n)if(l.galleryPIDs){for(var c=0;c<r.length;c++)if(r[c].pid==e){l.index=c;break}}else l.index=parseInt(e,10)-1;else l.index=parseInt(e,10);isNaN(l.index)||(a&&(l.showAnimationDuration=0),i=new PhotoSwipe(o,PhotoSwipeUI_Default,r,l),i.init())},l=document.querySelectorAll(e),r=0,o=l.length;r<o;r++)l[r].setAttribute("data-pswp-uid",r+1),l[r].onclick=a;var c=n();c.pid&&c.gid&&i(c.pid,l[c.gid-1],!0,!0)};$(function(){$("#fresh").attr("style","display:none;");var e=io(),t="",s=0,a=0,n=0,i=0,l=0,r=0;$("#myModal").modal("toggle","center"),t=document.getElementById("userNamein").value,""!==t&&null!=t||(t=Math.floor(1e5*Math.random())+""),t.length>20&&(t=Math.floor(1e5*Math.random())+""),$("#userNamed").html(t);var o="6";e.on("connect",function(){e.emit("join",t,o)}),e.on("msg",function(e,a){var o=new Date;if(e===t)var c='<div class="message">  <span class="userme" id="user'+s+'"> </span>  <span class="time">'+o.toLocaleTimeString()+'</span>  <span class="msg" id="msg'+s+'"> ';else c='<div class="message">  <span class="user" id="user'+s+'"> </span>  <span class="time">'+o.toLocaleTimeString()+'</span>  <span class="msg" id="msg'+s+'"> ';var g="",d=a.match(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?/g);if(null!==d){var m=a.replace(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?/g,"⋘");g=m.split("⋘");for(var p=0;p<g.length;p++)c=c.concat('</span><a target="_blank" id="urlid'+n+'"></a><span class="msg" id="msgno'+l+'"> '),n++,l++}if(c=c.concat("</span></div>"),$("#msglog").append(c),$("#user"+s).text(e),null!==d){$("#msg"+s).text(" : "+g[0]);for(p=0;p<g.length;p++)document.getElementById("urlid"+i).setAttribute("href",d[p]),$("#urlid"+i).text(d[p]),i++;for(p=1;p<=g.length;p++)$("#msgno"+r).text(g[p]),r++}else $("#msg"+s).text(" : "+a);s++,$("#msglog").scrollTop($("#msglog")[0].scrollHeight)}),e.on("img",function(e,a,n,i){var l=new Date;if(e===t)var r='<div class="message" class="my-gallery" itemscope itemtype="http://schema.org/ImageGallery">  <span class="userme" id="user'+s+'"> </span>  <span class="time">'+l.toLocaleTimeString()+'</span><div class="my-gallery" itemscope itemtype="http://schema.org/ImageGallery"><figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">  <a href="'+a+'" itemprop="contentUrl" data-size="'+n+"x"+i+'">  <img src="'+a+'" class="img-thumbnail" itemprop="thumbnail" alt="Image description" style="width: 200px"/></a></figure></div></div>';else r='<div class="message">  <span class="user" id="user'+s+'"> </span>  <span class="time">'+l.toLocaleTimeString()+'</span><div class="my-gallery" itemscope itemtype="http://schema.org/ImageGallery"><figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">  <a href="'+a+'" itemprop="contentUrl" data-size="'+n+"x"+i+'">  <img src="'+a+'" class="img-thumbnail" itemprop="thumbnail" alt="Image description" style="width: 200px;/></a></figure></div></div>';$("#msglog").append(r),$("#user"+s).text(e),s++,$("#msglog").scrollTop($("#msglog")[0].scrollHeight),initPhotoSwipeFromDOM(".my-gallery")}),e.on("sys",function(e,t){var s='<div class="sysMsg">  <span class="sysMsg" id="sys'+a+'"> </span> </div>';$("#msglog").append(s),$("#sys"+a).text(e),a++,$("#count").text(t.length),$("#cs").attr("data-content",t.join(","))}),e.on("dk",function(s,a,n){s==o&&(t=a,$("#userNamed").html(a),2==n&&e.emit("dk_ip",a))}),$(":input").change(function(){$("#loadIndicator1").toggleClass("loading");var t=this.files[0].size,s=new $.zui.Messager("图片正在压缩上传中，请耐心等待",{icon:"heart",time:0});s.show();const a=this.files[0];a&&new ImageCompressor(a,{quality:.6,success(a){new $.zui.Messager("图片压缩成功，压缩率"+(100-a.size/t*100).toFixed(2)+"%",{type:"success",icon:"check-circle"}).show();const n=new FormData;n.append("smfile",a),$.ajax({url:"https://sm.ms/api/v2/upload",type:"POST",data:n,cache:!1,contentType:!1,processData:!1,success:function(t){console.log(t),e.emit("messageimg",JSON.stringify(t.data.url).replace(/"/g,""),JSON.stringify(t.data.delete).replace(/"/g,""),JSON.stringify(t.data.width),JSON.stringify(t.data.height)),s.hide(),new $.zui.Messager("图片上传成功",{type:"success",icon:"icheck-circle"}).show(),$("#loadIndicator1").toggleClass("loading")},error:function(){s.hide(),new $.zui.Messager("图片上传失败，请重试",{type:"danger",icon:"remove-sign"}).show(),$("#loadIndicator1").toggleClass("loading")}})},error(e){console.log(e.message),new $.zui.Messager("图片压缩失败，请重试",{type:"danger",icon:"remove-sign"}).show(),$("#loadIndicator1").toggleClass("loading")}})}),$("#messageInput").keydown(function(t){if(13===t.which||10===t.which){t.preventDefault();var s=$(this).val();""!==s.replace(/ /g,"")&&(s.length<800?($(this).val(""),e.send(s)):alert("你输入了"+s.length+"个字符，最大支持800个字符"))}}),$("#sendMsg").click(function(t){t.preventDefault();var s=$("#messageInput").val();""!==s.replace(/ /g,"")&&(s.length<800?($("#messageInput").val(""),e.send(s)):alert("你输入了"+s.length+"个字符，最大支持800个字符"))}),$("#nick").click(function(){$("#setNick").text("更改昵称"),document.getElementById("nickInfo").style.display="none",$("#myModal").modal("toggle","center")}),$("#changeName").click(function(s){var a=document.getElementById("userNamein"),n=document.getElementById("userNamed");""!==a.value&&a.value.length<20&&(e.emit("change_name",n.innerText,a.value),t=a.value,$("#userNamed").text(t),$("#myModal").modal("hide","fit"),new $.zui.Messager("昵称更改成功",{type:"success",icon:"check-circle"}).show(),document.getElementById("userNamein").value="")}),$('[data-toggle="popover"]').popover(),$('[data-toggle="tooltip"]').tooltip()});